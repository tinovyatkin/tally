---
name: Sync BuildKit Rules
on:
  schedule:
    - cron: "0 1 * * 0" # Weekly on Sunday (after hadolint sync)
  workflow_dispatch: # Allow manual trigger
permissions:
  contents: write
  pull-requests: write
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Install rumdl
        run: pip install rumdl
      - name: Update README.md and RULES.md
        id: update
        run: |
          go run ./scripts/sync-buildkit-rules --update
          rumdl check --fix --config .rumdl.toml --output-format concise RULES.md README.md
          # Check if there are changes
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi
      - name: Create Pull Request
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: sync BuildKit rules"
          title: "docs: sync BuildKit rules"
          body: |
            This PR updates the BuildKit rules documentation based on the currently pinned BuildKit version.

            Changes may include:
            - New/removed BuildKit checks
            - Changes in which checks are parse-time vs LLB conversion-time
            - Updated auto-fix coverage

            ---
            *This PR was automatically generated by the sync-buildkit-rules workflow.*
          branch: chore/sync-buildkit-rules
          delete-branch: true
          labels: documentation
